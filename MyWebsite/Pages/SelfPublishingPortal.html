<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2575.7">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; -webkit-text-stroke: #000000; min-height: 16.0px}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; -webkit-text-stroke: #000000}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #900112; -webkit-text-stroke: #900112}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #0e6e6d; -webkit-text-stroke: #0e6e6d}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #0000ff; -webkit-text-stroke: #0000ff}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #0f7001; -webkit-text-stroke: #0f7001}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #900112; -webkit-text-stroke: #900112; min-height: 16.0px}
    span.s1 {font-kerning: none}
    span.s2 {font-kerning: none; color: #0000ff; background-color: #fffffe; -webkit-text-stroke: 0px #0000ff}
    span.s3 {font-kerning: none; background-color: #fffffe}
    span.s4 {font-kerning: none; color: #0e6e6d; background-color: #fffffe; -webkit-text-stroke: 0px #0e6e6d}
    span.s5 {font-kerning: none; color: #900112; background-color: #fffffe; -webkit-text-stroke: 0px #900112}
    span.s6 {font-kerning: none; color: #000000; background-color: #fffffe; -webkit-text-stroke: 0px #000000}
    span.s7 {font-kerning: none; color: #137646; background-color: #fffffe; -webkit-text-stroke: 0px #137646}
    span.s8 {font-kerning: none; color: #0f7001; background-color: #fffffe; -webkit-text-stroke: 0px #0f7001}
  </style>
</head>
<body>
<p class="p1"><span class="s1"></span><br></p>
<p class="p2"><span class="s2">import</span><span class="s3"> </span><span class="s4">React</span><span class="s3">, { useState, useEffect, useCallback } </span><span class="s2">from</span><span class="s3"> </span><span class="s5">'react'</span><span class="s3">;</span></p>
<p class="p2"><span class="s2">import</span><span class="s3"> { motion, </span><span class="s4">AnimatePresence</span><span class="s3"> } </span><span class="s2">from</span><span class="s3"> </span><span class="s5">'framer-motion'</span><span class="s3">;</span></p>
<p class="p3"><span class="s2">import</span><span class="s6"> { </span><span class="s4">User</span><span class="s6"> } </span><span class="s2">from</span><span class="s6"> </span><span class="s3">'@/entities/User'</span><span class="s6">;</span></p>
<p class="p3"><span class="s2">import</span><span class="s6"> { </span><span class="s4">WritingEntry</span><span class="s6"> } </span><span class="s2">from</span><span class="s6"> </span><span class="s3">'@/entities/WritingEntry'</span><span class="s6">;</span></p>
<p class="p3"><span class="s2">import</span><span class="s6"> { </span><span class="s4">InvokeLLM</span><span class="s6"> } </span><span class="s2">from</span><span class="s6"> </span><span class="s3">'@/integrations/Core'</span><span class="s6">;</span></p>
<p class="p3"><span class="s2">import</span><span class="s6"> { </span><span class="s4">Button</span><span class="s6"> } </span><span class="s2">from</span><span class="s6"> </span><span class="s3">'@/components/ui/button'</span><span class="s6">;</span></p>
<p class="p4"><span class="s2">import</span><span class="s6"> { </span><span class="s3">Card</span><span class="s6">, </span><span class="s3">CardContent</span><span class="s6">, </span><span class="s3">CardHeader</span><span class="s6">, </span><span class="s3">CardTitle</span><span class="s6"> } </span><span class="s2">from</span><span class="s6"> </span><span class="s5">'@/components/ui/card'</span><span class="s6">;</span></p>
<p class="p4"><span class="s2">import</span><span class="s6"> { </span><span class="s3">Loader2</span><span class="s6">, </span><span class="s3">Book</span><span class="s6">, </span><span class="s3">Edit</span><span class="s6">, </span><span class="s3">Palette</span><span class="s6">, </span><span class="s3">Send</span><span class="s6">, </span><span class="s3">FileText</span><span class="s6">, </span><span class="s3">Upload</span><span class="s6">, </span><span class="s3">Sparkles</span><span class="s6">, </span><span class="s3">Star</span><span class="s6">, </span><span class="s3">Lock</span><span class="s6">, </span><span class="s3">Crown</span><span class="s6"> } </span><span class="s2">from</span><span class="s6"> </span><span class="s5">'lucide-react'</span><span class="s6">;</span></p>
<p class="p3"><span class="s2">import</span><span class="s6"> </span><span class="s4">ReactQuill</span><span class="s6"> </span><span class="s2">from</span><span class="s6"> </span><span class="s3">'react-quill'</span><span class="s6">;</span></p>
<p class="p3"><span class="s2">import</span><span class="s6"> </span><span class="s3">'react-quill/dist/quill.snow.css'</span><span class="s6">;</span></p>
<p class="p3"><span class="s2">import</span><span class="s6"> </span><span class="s4">ProgressCheckpoints</span><span class="s6"> </span><span class="s2">from</span><span class="s6"> </span><span class="s3">'../components/publishing/ProgressCheckpoints'</span><span class="s6">;</span></p>
<p class="p1"><span class="s1"></span><br></p>
<p class="p4"><span class="s2">const</span><span class="s6"> </span><span class="s3">WORDS_PER_PAGE</span><span class="s6"> = </span><span class="s7">250</span><span class="s6">;</span></p>
<p class="p4"><span class="s2">const</span><span class="s6"> </span><span class="s3">REQUIRED_PAGES</span><span class="s6"> = </span><span class="s7">100</span><span class="s6">;</span></p>
<p class="p1"><span class="s1"></span><br></p>
<p class="p5"><span class="s3">export</span><span class="s6"> </span><span class="s3">default</span><span class="s6"> </span><span class="s3">function</span><span class="s6"> </span><span class="s4">SelfPublishingPortal</span><span class="s6">() {</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">  </span></span><span class="s2">const</span><span class="s3"> [isLoading, setIsLoading] = useState(</span><span class="s2">true</span><span class="s3">);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">  </span></span><span class="s2">const</span><span class="s3"> [user, setUser] = useState(</span><span class="s2">null</span><span class="s3">);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">  </span></span><span class="s2">const</span><span class="s3"> [entries, setEntries] = useState([]);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">  </span></span><span class="s2">const</span><span class="s3"> [totalWords, setTotalWords] = useState(</span><span class="s7">0</span><span class="s3">);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">  </span></span><span class="s2">const</span><span class="s3"> [currentPages, setCurrentPages] = useState(</span><span class="s7">0</span><span class="s3">); </span><span class="s8">// New state for current pages</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">  </span></span><span class="s2">const</span><span class="s3"> [hasAccess, setHasAccess] = useState(</span><span class="s2">false</span><span class="s3">);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">  </span></span><span class="s2">const</span><span class="s3"> [isAdmin, setIsAdmin] = useState(</span><span class="s2">false</span><span class="s3">); </span><span class="s8">// New state for admin status</span></p>
<p class="p1"><span class="s3"><span class="Apple-converted-space">  </span></span></p>
<p class="p6"><span class="s6"><span class="Apple-converted-space">  </span></span><span class="s3">// Checkpoint system</span></p>
<p class="p6"><span class="s6"><span class="Apple-converted-space">  </span></span><span class="s2">const</span><span class="s6"> [lastSeenPages, setLastSeenPages] = useState(</span><span class="s7">0</span><span class="s6">); </span><span class="s3">// Tracks the highest page count where a checkpoint was last acknowledged</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">  </span></span><span class="s2">const</span><span class="s3"> [showCheckpoint, setShowCheckpoint] = useState(</span><span class="s2">false</span><span class="s3">); </span><span class="s8">// Controls checkpoint modal visibility</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">  </span></span><span class="s2">const</span><span class="s3"> [unlockedPreviews, setUnlockedPreviews] = useState([]); </span><span class="s8">// Stores milestones for which previews have been unlocked</span></p>
<p class="p1"><span class="s3"><span class="Apple-converted-space">  </span></span></p>
<p class="p6"><span class="s6"><span class="Apple-converted-space">  </span></span><span class="s2">const</span><span class="s6"> [step, setStep] = useState(</span><span class="s5">'manuscript'</span><span class="s6">); </span><span class="s3">// manuscript, edit, design, finalize</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">  </span></span><span class="s2">const</span><span class="s3"> [compiledManuscript, setCompiledManuscript] = useState(</span><span class="s5">''</span><span class="s3">);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">  </span></span><span class="s2">const</span><span class="s3"> [editedManuscript, setEditedManuscript] = useState(</span><span class="s5">''</span><span class="s3">);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">  </span></span><span class="s2">const</span><span class="s3"> [aiSuggestions, setAiSuggestions] = useState([]);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">  </span></span><span class="s2">const</span><span class="s3"> [isSuggesting, setIsSuggesting] = useState(</span><span class="s2">false</span><span class="s3">);</span></p>
<p class="p1"><span class="s1"></span><br></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">  </span>useEffect(() =&gt; {</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">    </span></span><span class="s2">const</span><span class="s3"> checkAccess = </span><span class="s2">async</span><span class="s3"> () =&gt; {</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">      </span>setIsLoading(</span><span class="s2">true</span><span class="s3">);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">      </span></span><span class="s2">try</span><span class="s3"> {</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">const</span><span class="s3"> currentUser = </span><span class="s2">await</span><span class="s3"> </span><span class="s4">User</span><span class="s3">.me();</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">        </span>setUser(currentUser);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">        </span>setIsAdmin(currentUser.role === </span><span class="s5">'admin'</span><span class="s3">); </span><span class="s8">// Set isAdmin state</span></p>
<p class="p1"><span class="s3"><span class="Apple-converted-space">        </span></span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">const</span><span class="s3"> userEntries = </span><span class="s2">await</span><span class="s3"> </span><span class="s4">WritingEntry</span><span class="s3">.filter({ created_by: currentUser.email });</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">        </span>setEntries(userEntries);</span></p>
<p class="p1"><span class="s3"><span class="Apple-converted-space">        </span></span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">const</span><span class="s3"> wordCount = userEntries.reduce((sum, entry) =&gt; sum + (entry.word_count || </span><span class="s7">0</span><span class="s3">), </span><span class="s7">0</span><span class="s3">);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">const</span><span class="s3"> pages = </span><span class="s4">Math</span><span class="s3">.floor(wordCount / </span><span class="s4">WORDS_PER_PAGE</span><span class="s3">); </span><span class="s8">// Calculate current pages</span></p>
<p class="p1"><span class="s3"><span class="Apple-converted-space">        </span></span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">        </span>setTotalWords(wordCount);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">        </span>setCurrentPages(pages); </span><span class="s8">// Update current pages state</span></p>
<p class="p1"><span class="s3"><span class="Apple-converted-space">        </span></span></p>
<p class="p6"><span class="s6"><span class="Apple-converted-space">        </span></span><span class="s3">// Check for new checkpoints (gamification logic)</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">const</span><span class="s3"> lastSeen = parseInt(localStorage.getItem(</span><span class="s5">'lastSeenPages'</span><span class="s3">) || </span><span class="s5">'0'</span><span class="s3">);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">        </span>setLastSeenPages(lastSeen);</span></p>
<p class="p1"><span class="s3"><span class="Apple-converted-space">        </span></span></p>
<p class="p6"><span class="s6"><span class="Apple-converted-space">        </span></span><span class="s3">// Trigger checkpoint if current pages pass a new 10-page milestone, starting from 10 pages</span></p>
<p class="p6"><span class="s6"><span class="Apple-converted-space">        </span></span><span class="s3">// The condition `Math.floor(pages / 10) * 10 &gt; lastSeen` ensures it only triggers for new 10-page multiples.</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">if</span><span class="s3"> (pages &gt;= </span><span class="s7">10</span><span class="s3"> &amp;&amp; </span><span class="s4">Math</span><span class="s3">.floor(pages / </span><span class="s7">10</span><span class="s3">) * </span><span class="s7">10</span><span class="s3"> &gt; lastSeen) {</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">          </span>setShowCheckpoint(</span><span class="s2">true</span><span class="s3">);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s3"><span class="Apple-converted-space">        </span></span></p>
<p class="p6"><span class="s6"><span class="Apple-converted-space">        </span></span><span class="s3">// Load unlocked previews from local storage</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">const</span><span class="s3"> unlocked = </span><span class="s4">JSON</span><span class="s3">.parse(localStorage.getItem(</span><span class="s5">'unlockedPreviews'</span><span class="s3">) || </span><span class="s5">'[]'</span><span class="s3">);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">        </span>setUnlockedPreviews(unlocked);</span></p>
<p class="p1"><span class="s3"><span class="Apple-converted-space">        </span></span></p>
<p class="p6"><span class="s6"><span class="Apple-converted-space">        </span></span><span class="s3">// Check access (admin override or 100+ pages)</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">if</span><span class="s3"> (currentUser.role === </span><span class="s5">'admin'</span><span class="s3"> || pages &gt;= </span><span class="s4">REQUIRED_PAGES</span><span class="s3">) {</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">          </span>setHasAccess(</span><span class="s2">true</span><span class="s3">);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">      </span>} </span><span class="s2">catch</span><span class="s3"> (error) {</span></p>
<p class="p3"><span class="s6"><span class="Apple-converted-space">        </span>console.error(</span><span class="s3">"Error checking publishing access:"</span><span class="s6">, error);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">      </span>} </span><span class="s2">finally</span><span class="s3"> {</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">        </span>setIsLoading(</span><span class="s2">false</span><span class="s3">);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">    </span>checkAccess();</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">  </span>}, []);</span></p>
<p class="p1"><span class="s1"></span><br></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">  </span></span><span class="s2">const</span><span class="s3"> handleCompileManuscript = () =&gt; {</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">    </span></span><span class="s2">const</span><span class="s3"> content = entries.map(entry =&gt; </span><span class="s5">`&lt;h2&gt;Entry from </span><span class="s3">${</span><span class="s2">new</span><span class="s3"> </span><span class="s4">Date</span><span class="s3">(entry.created_date).toLocaleDateString()}</span><span class="s5">&lt;/h2&gt;\n</span><span class="s3">${entry.content}</span><span class="s5">`</span><span class="s3">).join(</span><span class="s5">'&lt;hr/&gt;\n'</span><span class="s3">);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">    </span>setCompiledManuscript(content);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">    </span>setEditedManuscript(content);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">    </span>setStep(</span><span class="s5">'edit'</span><span class="s3">);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"></span><br></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">  </span></span><span class="s2">const</span><span class="s3"> getAiSuggestions = </span><span class="s2">async</span><span class="s3"> () =&gt; {</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">    </span>setIsSuggesting(</span><span class="s2">true</span><span class="s3">);</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">    </span></span><span class="s2">try</span><span class="s3"> {</span></p>
<p class="p2"><span class="s3"><span class="Apple-converted-space">      </span></span><span class="s2">const</span><span class="s3"> response = </span><span class="s2">await</span><span class="s3"> </span><span class="s4">InvokeLLM</span><span class="s3">({</span></p>
<p class="p3"><span class="s6"><span class="Apple-converted-space">        </span>prompt: </span><span class="s3">`Act as a constructive and gentle editor. Review the following manuscript text and provide 3-5 high-level suggestions for improvement focusing on theme, structure, and emotional flow. Do not rewrite sentences. Frame suggestions as questions or gentle observations.</span></p>
<p class="p7"><span class="s3"><span class="Apple-converted-space"> </span></span></p>
</body>
</html>
